{% if request.page_type == 'product' %}
<script>
  document.addEventListener("DOMContentLoaded", function() {
    console.log("FAQ App Embed: Script started"); // Helps us debug in the browser console

    // 1. Get the current product ID
    const currentProductId = "gid://shopify/Product/{{ product.id }}";
    console.log("FAQ App Embed: Checking product ID", currentProductId);
    
    // 2. Fetch the FAQs (Make sure this URL matches your actual live/Vercel API URL)
    const apiUrl = `https://themee-xi.vercel.app/api/faqs?productId=${encodeURIComponent(currentProductId)}`;

    fetch(apiUrl)
      .then(response => response.json())
      .then(data => {
        // 3. If no FAQs exist for this product, do nothing
        if (Object.keys(data).length === 0) {
          console.log("FAQ App Embed: No FAQs assigned to this product. Staying hidden.");
          return;
        }

        console.log("FAQ App Embed: Found FAQs, building HTML...");

        // 4. Build the HTML for the FAQs
        let faqHtml = `
          <div class="custom-faq-wrapper" style="max-width: 800px; margin: 40px auto; padding: 20px; clear: both;">
            <h2 style="text-align: center; margin-bottom: 20px;">Frequently Asked Questions</h2>
        `;

        for (const [title, questions] of Object.entries(data)) {
          faqHtml += `<div style="margin-bottom: 20px;">
                        <h3 style="margin-bottom: 10px; border-bottom: 1px solid #ccc; padding-bottom: 5px;">${title}</h3>`;
          
          questions.forEach(q => {
            faqHtml += `<details style="margin-bottom: 10px; background: #f9f9f9; padding: 10px; border-radius: 5px;">
                          <summary style="font-weight: bold; cursor: pointer;">${q.question}</summary>
                          <p style="margin-top: 10px; color: #555;">${q.answer}</p>
                        </details>`;
          });
          faqHtml += `</div>`;
        }
        faqHtml += `</div>`;

        // 5. AUTO-INJECT THE HTML INTO THE PAGE
        // We look for standard Shopify product containers
        const targetContainer = document.querySelector('.product__info-wrapper') || 
                                document.querySelector('.product-single__meta') || 
                                document.querySelector('.product__description') ||
                                document.querySelector('.product-section');
        
        if (targetContainer) {
          console.log("FAQ App Embed: Injecting right after the product container.");
          targetContainer.insertAdjacentHTML('afterend', faqHtml);
        } else {
          // Fallback: If we can't find specific classes, attach it to the bottom of the main content
          const mainArea = document.querySelector('main') || document.querySelector('#MainContent');
          if (mainArea) {
             console.log("FAQ App Embed: Specific container not found, injecting at the bottom of the page.");
             mainArea.insertAdjacentHTML('beforeend', faqHtml);
          } else {
             console.error("FAQ App Embed: Could not find any suitable area to inject the FAQs on this theme.");
          }
        }
      })
      .catch(error => console.error("FAQ App Embed: Error loading APIs:", error));
  });
</script>
{% endif %}

{% schema %}
{
  "name": "Auto FAQ Injector",
  "target": "body",
  "settings": []
}
{% endschema %}