{% if product %}
<div class="custom-faq-wrapper" style="max-width: 800px; margin: 40px auto; padding: 20px;">
  <h2 id="faq-heading-{{ block.id }}" style="text-align: {{ block.settings.heading_align }}; display: none;">
    {{ block.settings.heading }}
  </h2>
  
  <div id="faq-container-{{ block.id }}">
    </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    // We format the Shopify Product ID to match what the Database saved (GID format)
    const currentProductId = "gid://shopify/Product/{{ product.id }}";
    
    // REPLACE YOUR_APP_URL with your actual ngrok/cloudflare URL
    const apiUrl = `https://shopify-theme-xi.vercel.app/api/faqs?productId=${encodeURIComponent(currentProductId)}`; 

    fetch(apiUrl)
      .then(response => response.json())
      .then(data => {
        const container = document.getElementById("faq-container-{{ block.id }}");
        
        // If there are no FAQs assigned to this specific product, hide the block entirely
        if (Object.keys(data).length === 0) {
          container.innerHTML = "";
          return;
        }

        // Show the heading if we have FAQs
        document.getElementById("faq-heading-{{ block.id }}").style.display = "block";

        let html = "";
        for (const [title, questions] of Object.entries(data)) {
          html += `<div style="margin-bottom: 20px;">
                        <h3 style="margin-bottom: 10px; border-bottom: 1px solid #ccc; padding-bottom: 5px;">${title}</h3>`;
          
          questions.forEach(q => {
            html += `<details style="margin-bottom: 10px; background: #f9f9f9; padding: 10px; border-radius: 5px;">
                       <summary style="font-weight: bold; cursor: pointer;">${q.question}</summary>
                       <p style="margin-top: 10px; color: #555;">${q.answer}</p>
                     </details>`;
          });
          
          html += `</div>`;
        }
        container.innerHTML = html;
      })
      .catch(error => console.error("Error loading FAQs:", error));
  });
</script>
{% endif %}

{% schema %}
{
  "name": "Product FAQs",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Frequently Asked Questions"
    },
    {
      "type": "select",
      "id": "heading_align",
      "label": "Heading Alignment",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" }
      ],
      "default": "center"
    }
  ]
}
{% endschema %}