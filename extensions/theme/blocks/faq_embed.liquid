{% if request.page_type == 'product' %}

<div id="faq-app-placeholder" style="display:none;"></div>

<style>
  /* Base Container */
  .faq-app-section {
    padding: 60px 20px;
    width: 100%;
    max-width: 1000px; /* Constrain width for readability */
    margin: 40px auto; 
    font-family: inherit;
    box-sizing: border-box;
  }
  .faq-app-title { 
    text-align: center; 
    margin-bottom: 50px; 
    font-size: 26px;
    font-weight: 600;
    letter-spacing: -0.02em;
    color: #121212;
  }

  /* --- STYLE: ACCORDION --- */
  .faq-style-accordion .faq-item {
    border: none;
    border-bottom: 1px solid #e1e3e5;
    background: transparent;
  }
  .faq-style-accordion .faq-item:first-child { border-top: 1px solid #e1e3e5; }
  
  .faq-style-accordion summary {
    padding: 24px 0;
    cursor: pointer;
    font-weight: 500;
    font-size: 18px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    list-style: none;
    transition: opacity 0.2s ease;
    color: #121212;
  }
  .faq-style-accordion summary:hover { opacity: 0.7; }
  .faq-style-accordion summary::-webkit-details-marker { display: none; }
  .faq-style-accordion .faq-answer {
    padding: 0 0 24px;
    color: #4a4a4a;
    line-height: 1.6;
    font-size: 16px;
  }

  /* --- STYLE: GRID --- */
  .faq-style-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 30px;
  }
  .faq-style-grid .faq-card {
    padding: 30px;
    border: 1px solid #e1e3e5;
    background: #f9f9f9;
    border-radius: 8px;
  }

  /* --- STYLE: MINIMAL --- */
  .faq-style-minimal .faq-item {
    border-bottom: 1px solid #e1e3e5;
    padding: 25px 0;
  }
  .faq-style-minimal h3 { margin: 0 0 10px 0; font-size: 18px; font-weight: 600; }
  .faq-style-minimal p { margin: 0; color: #555; line-height: 1.6; font-size: 16px; }

  /* --- STYLE: CHAT --- */
  .faq-style-chat {
    background: #fff;
    border: 1px solid #e1e3e5;
    max-width: 700px;
    margin: 0 auto;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0,0,0,0.05);
  }
  .faq-chat-header {
    padding: 20px;
    background: #f4f6f8;
    border-bottom: 1px solid #e1e3e5;
    display: flex;
    align-items: center;
    gap: 15px;
    font-weight: 600;
  }
  .faq-chat-body { padding: 30px; display: flex; flex-direction: column; gap: 20px; }
  .faq-bubble-bot {
    align-self: flex-start;
    background: #f4f6f8;
    padding: 15px 20px;
    border-radius: 0 20px 20px 20px;
    font-size: 15px;
    line-height: 1.5;
  }
  .faq-bubble-user {
    align-self: flex-end;
    padding: 12px 20px;
    border-radius: 20px 20px 0 20px;
    border: 1px solid;
    cursor: pointer;
    background: #fff;
    font-size: 15px;
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    var currentProductId = "gid://shopify/Product/{{ product.id }}";
    var shopDomain = "{{ shop.permanent_domain }}";

    // --- CONFIGURATION ---
    // Change this URL for local development vs production
    var appUrl = "https://62e6-2a09-bac5-3afe-1a46-00-29e-85.ngrok-free.app"; 
    
    var apiUrl = appUrl + "/api/faqs/product?productId=" + encodeURIComponent(currentProductId) + "&shop=" + encodeURIComponent(shopDomain);

    fetch(apiUrl, {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
        "ngrok-skip-browser-warning": "true"
      }
    })
      .then(function(res) { 
        if (!res.ok) throw new Error("HTTP " + res.status);
        return res.json(); 
      })
      .then(function(data) {
        if (!data.content || Object.keys(data.content).length === 0) return;

        var config = data.config || { style: 'accordion', color: '#008060', radius: 8 };
        var faqs = Object.values(data.content).flat();
        
        // Find suitable container to append to (at the bottom)
        // Order of preference: 'main' tag -> '#MainContent' -> body
        var root = document.createElement('div');
        root.id = 'faq-app-root';
        
        var targetContainer = document.querySelector('main') || document.querySelector('#MainContent');
        if (targetContainer) {
             targetContainer.appendChild(root);
        } else {
             document.body.appendChild(root);
        }

        var html = '<div class="faq-app-section">';

        // 1. ACCORDION
        if (config.style === 'accordion') {
           html += '<h2 class="faq-app-title">Frequently Asked Questions</h2>' +
                    '<div class="faq-style-accordion" style="display:flex; flex-direction:column; gap:0;">';
           faqs.forEach(function(f) {
              html += '<details class="faq-item" style="border-radius:' + config.radius + 'px;">' +
                        '<summary><span>' + f.question + '</span><span style="display:flex; align-items:center; justify-content:center; width:24px; height:24px; color:' + config.color + ';">+</span></summary>' +
                        '<div class="faq-answer">' + f.answer + '</div>' +
                      '</details>';
           });
           html += '</div>';
        }
        // 2. GRID
        else if (config.style === 'grid') {
           html += '<h2 class="faq-app-title">Frequently Asked Questions</h2>' +
                    '<div class="faq-style-grid">';
           faqs.forEach(function(f) {
              html += '<div class="faq-card" style="border-radius:' + config.radius + 'px; border-top: 4px solid ' + config.color + ';">' +
                        '<h3 style="margin:0 0 10px 0; font-weight:bold;">' + f.question + '</h3>' +
                        '<p style="margin:0; color:#666; line-height:1.4;">' + f.answer + '</p>' +
                      '</div>';
           });
           html += '</div>';
        }
        // 3. MINIMAL
        else if (config.style === 'minimal') {
           html += '<h2 class="faq-app-title">Frequently Asked Questions</h2>' +
                    '<div class="faq-style-minimal" style="border-top:1px solid #e1e3e5;">';
           faqs.forEach(function(f) {
              html += '<div class="faq-item">' +
                        '<h3>' + f.question + '</h3>' +
                        '<p>' + f.answer + '</p>' +
                        '<div style="color:' + config.color + '; font-size:20px; line-height:1; margin-top:5px;">+</div>' +
                      '</div>';
           });
           html += '</div>';
        }
        // 4. CHAT
        else if (config.style === 'chat') {
           html += '<div class="faq-style-chat" style="border-radius:' + config.radius + 'px;">' +
                     '<div class="faq-chat-header">' +
                       '<div style="width:30px; height:30px; border-radius:50%; background:' + config.color + '; color:white; display:flex; align-items:center; justify-content:center; font-size:12px;">AI</div>' +
                       '<span>Support Bot</span>' +
                     '</div>' +
                     '<div class="faq-chat-body">' +
                       '<div class="faq-bubble-bot">How can I help you today?</div>';
           faqs.forEach(function(f) {
              html += '<div class="faq-bubble-user" style="color:' + config.color + '; border-color:' + config.color + ';">' + f.question + '</div>';
           });
           html += '</div></div>';
        }

        html += '</div>';
        root.innerHTML = html;
      })
      .catch(function(e) { console.error("FAQ App: Load Error", e); });
  });
</script>
{% endif %}

{% schema %}
{
  "name": "Product FAQs",
  "target": "body",
  "settings": []
}
{% endschema %}
