{% schema %}
{
  "name": "Product Testimonials",
  "target": "body",
  "settings": []
}
{% endschema %}

<div id="testi-app-embedded"></div>

<style>
  #testi-app-embedded { width: 100%; margin: 60px 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; clear: both; display: block; }
  .testi-app-inner { max-width: 1000px; margin: 0 auto; padding: 0 20px; }
  .testi-app-title { font-size: 24px; font-weight: 700; margin-bottom: 24px; color: #333; text-align: center; }

  /* 1. Grid */
  .testi-style-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; }
  .testi-card-grid { padding: 20px; border: 1px solid #e1e3e5; background: #fff; display: flex; flex-direction: column; }
  .testi-card-grid p { margin: 0 0 15px 0; color: #444; font-size: 14px; line-height: 1.5; flex: 1; font-style: italic; }
  .testi-card-grid h4 { margin: 0 0 2px 0; font-size: 14px; font-weight: bold; color: #202223; }
  .testi-card-grid span { font-size: 12px; color: #666; }

  /* 2. List */
  .testi-style-list { display: flex; flex-direction: column; gap: 15px; }
  .testi-card-list { padding: 20px; border: 1px solid #e1e3e5; background: #fff; display: flex; gap: 15px; align-items: flex-start; }
  .testi-list-header { display: flex; align-items: center; gap: 10px; margin-bottom: 4px; }
  .testi-list-header h4 { margin: 0; font-size: 15px; font-weight: bold; color: #202223; }
  .testi-list-header span { font-size: 12px; color: #666; }
  .testi-card-list p { margin: 8px 0 0 0; color: #444; font-size: 14px; line-height: 1.5; }

  /* 3. Minimal */
  .testi-style-minimal { display: flex; flex-direction: column; gap: 40px; padding: 20px 0; }
  .testi-card-minimal { text-align: center; max-width: 600px; margin: 0 auto; }
  .testi-card-minimal .quote-mark { font-size: 40px; line-height: 0.8; opacity: 0.5; margin-bottom: 10px; }
  .testi-card-minimal p { margin: 0 0 20px 0; color: #202223; font-size: 18px; font-style: italic; line-height: 1.6; }
  .testi-card-minimal h4 { margin: 0 0 4px 0; font-size: 14px; font-weight: bold; color: #202223; text-transform: uppercase; letter-spacing: 1px; }
  .testi-card-minimal span { font-size: 12px; color: #666; }

  /* 4. Social */
  .testi-style-social { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; }
  .testi-card-social { padding: 20px; border: 1px solid #e1e3e5; background: #white; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
  .testi-social-header { display: flex; align-items: center; gap: 12px; margin-bottom: 15px; }
  .testi-social-header h4 { margin: 0; font-size: 14px; font-weight: bold; color: #202223; }
  .testi-social-header span { font-size: 13px; color: #666; }
  .testi-card-social p { margin: 0; color: #202223; font-size: 14px; line-height: 1.5; }
  .testi-social-footer { margin-top: 15px; font-size: 13px; font-weight: 500; }
</style>

<script>
  (function() {
    var shopDomain = '{{ shop.permanent_domain }}';
    var productId = '{{ product.id }}';
    var productGid = 'gid://shopify/Product/' + productId;
    
    var appUrl = "https://themee-xi.vercel.app";
    var API_URL = appUrl + "/api/testimonials/product";

    function getStars(rating, color) {
      var stars = '';
      for(var i=1; i<=5; i++) {
        var fill = i <= rating ? color : "#e1e3e5";
        stars += '<svg width="16" height="16" viewBox="0 0 24 24" fill="'+fill+'" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" /></svg>';
      }
      return '<div style="display:flex; gap:2px; margin-bottom:8px;">' + stars + '</div>';
    }

    function getAvatar(name, color) {
      var initial = name ? name.charAt(0).toUpperCase() : '?';
      return '<div style="width:40px; height:40px; border-radius:50%; background:'+color+'20; color:'+color+'; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:16px; flex-shrink:0;">' + initial + '</div>';
    }

    function loadTestimonials() {
      fetch(API_URL + "?shop=" + shopDomain + "&productId=" + productGid)
      .then(function(res) { return res.json(); })
      .then(function(data) {
        if (!data || !data.testimonials || data.testimonials.length === 0) return;
        renderTestimonials(data.testimonials, data.config);
      })
      .catch(function(err) { console.log("Testimonial App Error:", err); });
    }

    function renderTestimonials(testimonials, config) {
      var container = document.getElementById('testi-app-embedded');
      if (!container) return;

      var target = document.querySelector('.product-recommendations') || document.querySelector('#product-recommendations') || document.querySelector('.related-products');
      if (target && target.parentNode) {
        target.parentNode.insertBefore(container, target.nextSibling);
      } else {
        var main = document.querySelector('main') || document.querySelector('#MainContent');
        if (main) main.appendChild(container);
      }

      var html = '<div class="testi-app-inner">';
      html += '<h2 class="testi-app-title">Customer Reviews</h2>';

      if (config.style === 'grid') {
        html += '<div class="testi-style-grid">';
        testimonials.forEach(function(t) {
          html += '<div class="testi-card-grid" style="border-radius:' + config.radius + 'px;">' +
                    getStars(t.rating, config.color) +
                    '<p>"' + t.content + '"</p>' +
                    '<div><h4>' + t.author + '</h4><span>' + (t.subtitle || '') + '</span></div>' +
                  '</div>';
        });
        html += '</div>';
      } 
      else if (config.style === 'list') {
        html += '<div class="testi-style-list">';
        testimonials.forEach(function(t) {
          html += '<div class="testi-card-list" style="border-radius:' + config.radius + 'px;">' +
                    getAvatar(t.author, config.color) +
                    '<div>' +
                      '<div class="testi-list-header"><h4>' + t.author + '</h4><span>• ' + (t.subtitle || '') + '</span></div>' +
                      getStars(t.rating, config.color) +
                      '<p>' + t.content + '</p>' +
                    '</div>' +
                  '</div>';
        });
        html += '</div>';
      }
      else if (config.style === 'minimal') {
        html += '<div class="testi-style-minimal">';
        testimonials.forEach(function(t) {
          html += '<div class="testi-card-minimal">' +
                    '<div class="quote-mark" style="color:' + config.color + ';">"</div>' +
                    '<p>' + t.content + '</p>' +
                    '<h4>— ' + t.author + '</h4>' +
                    '<span>' + (t.subtitle || '') + '</span>' +
                  '</div>';
        });
        html += '</div>';
      }
      else if (config.style === 'social') {
        html += '<div class="testi-style-social">';
        testimonials.forEach(function(t) {
          var verificationText = t.rating === 5 ? 'Highly Recommended!' : 'Verified Purchase';
          html += '<div class="testi-card-social" style="border-radius:' + config.radius + 'px;">' +
                    '<div class="testi-social-header">' +
                      getAvatar(t.author, config.color) +
                      '<div><h4>' + t.author + '</h4><span>@' + t.author.replace(/\s+/g, '').toLowerCase() + '</span></div>' +
                      '<div style="margin-left:auto; color:#1da1f2;"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M24 4.557c-.883.392-1.832.656-2.828.775 1.017-.609 1.798-1.574 2.165-2.724-.951.564-2.005.974-3.127 1.195-.897-.957-2.178-1.555-3.594-1.555-3.179 0-5.515 2.966-4.797 6.045-4.091-.205-7.719-2.165-10.148-5.144-1.29 2.213-.669 5.108 1.523 6.574-.806-.026-1.566-.247-2.229-.616-.054 2.281 1.581 4.415 3.949 4.89-.693.188-1.452.232-2.224.084.626 1.956 2.444 3.379 4.6 3.419-2.07 1.623-4.678 2.348-7.29 2.04 2.179 1.397 4.768 2.212 7.548 2.212 9.142 0 14.307-7.721 13.995-14.646.962-.695 1.797-1.562 2.457-2.549z"/></svg></div>' +
                    '</div>' +
                    '<p>' + t.content + '</p>' +
                    '<div class="testi-social-footer" style="color:' + config.color + ';">' + verificationText + '</div>' +
                  '</div>';
        });
        html += '</div>';
      }

      html += '</div>';
      container.innerHTML = html;
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadTestimonials);
    } else {
      loadTestimonials();
    }

  })();
</script>